"use strict";function imgDropInit(){function t(t){if(!t||t.target&&("IMG"==t.target.tagName||"A"==t.target.tagName))return!1;if(!t.dataTransfer.types)return!0;for(var e=0;e<t.dataTransfer.types.length;e++)if("Files"==t.dataTransfer.types[e])return!0;return!1}function e(t){d&&(clearTimeout(u),u=setTimeout(function(){o()},100),t.dataTransfer&&(t.dataTransfer.dropEffect="copy"))}function i(t,e,i){t&&3!=t.nodeType&&8!=t.nodeType&&(t.setInterval&&t!=window&&(t=window),i.elem=t,n(e.split(/\s+/),function(e,n){t.addEventListener?t.addEventListener(n,i,!1):t.attachEvent&&t.attachEvent("on"+n,i)}),t=null)}function n(t,e){var i,n=0,s=t.length;if(void 0===s){for(i in t)if(e.call(t[i],i,t[i])===!1)break}else for(var r=t[0];n<s&&e.call(r,n,r)!==!1;r=t[++n]);return t}function s(t){if(!t||!window.FileReader)return!1;t.size>999999?(Math.round(t.size/10485.76)/100).toFixed(2)+"МБ":Math.round(t.size/1024)+"КБ";return"image/jpeg"!=t.type&&"image/png"!=t.type&&"image/gif"!=t.type&&"image/svg+xml"!=t.type?(alert("Доступные форматы изображений: jpg, png, gif, svg"),!1):!(t.size>2*Math.pow(2,20))||(alert("Слишком большое изображение (Макс: 2 МБ)"),!1)}function r(t){$.ajax({url:"img-process.php",type:"POST",data:t,success:function(t){t&&0!=t&&$(".image-url").val(t)},xhr:function(){return myXhr=$.ajaxSettings.xhr(),myXhr.upload&&i(myXhr.upload,"progress",function(t){$(".af-progress i").stop().css({visibility:"visible",opacity:1,width:t.loaded/t.total*100+"%"})}),myXhr},cache:!1,contentType:!1,processData:!1}).done(function(){$(".af-progress i").stop().animate({opacity:0},500,function(){$(".af-progress i").width(0).css("visibility","hidden")})})}function a(){$(".dropzone").css("visibility","visible")}function o(){$(".dropzone").css("visibility","hidden")}$(".af-imgupload > a").click(function(t){a(),t.preventDefault()}),$(window).keydown(function(t){27===t.keyCode&&o()});var u,d=0;"dragover dragenter drop dragleave".split(" ").forEach(function(t){window.addEventListener(t,function(t){t.preventDefault()})}),i(window,"dragenter",function(e){d||(d=t(e)?1:0),d&&(clearTimeout(u),a())}),i(window,"dragover",e),i(window,"dragleave",e),i(window,"drop",function(t){if(o(),s(t.dataTransfer.files[0])){var e=new FormData;e.append("upload_files",t.dataTransfer.files[0]),r(e)}})}var formatScheme=function(t){return schemesFormat.run(t)},schemesHandler={logo:function(t,e){return t.find("li").each(function(){var t=$(this).html().split("&gt;&gt;");$(this).html('\n                <div class="'+e+'-letter">'+t[0]+'</div>\n                <div class="'+e+'-hint block-hint">'+t[1]+"</div>\n            ")}),t},map:function(t,e){var i=t.find("li:first-child").text().split("|"),n=i[1].split("x");return t.find("li:first-child").remove(),t.css({backgroundImage:'url("'+i[0].trim()+'")',width:parseInt(n[0]),height:parseInt(n[1])}),t.find("li").each(function(){var t=$(this).html(),i=[50,50];"["==t[0]&&t.indexOf("]")>-1&&(i=t.split("]")[0].split(",").map(function(t){return parseInt(t.replace(/\[/,""))}),i.forEach(function(t,e){i[e]=i[e]/100*n[e],i[e]+=e?-18:30,i[e]=i[e]/n[e]*100+"%"}),t=t.split("]"),t.shift(),t=t.join("]")),$(this).css({left:i[0],top:i[1]}).html('\n<div class="'+e+'-point"> </div>\n<div class="'+e+'-hint block-hint">'+t.replace(/\&nbsp\;/,"").trim()+"</div>\n")}),t},accordeon:function(t,e){var i;return t.find("li").each(function(t){if(0==t&&$(this).text().indexOf("высота блока:")>-1){var e=15;i=parseInt($(this).text().replace(/[^0-9.]/gm,""))*(1.2*e)+20+50,$(this).remove()}}),t.find("li").each(function(t){$(this).height(i);var e=$(this).html().split("&gt;&gt;");$(this).attr("data-title",e[0]).html("\n<div>"+e[1]+"</div>\n"),0==t&&$(this).addClass("showed")}),t.find("li").attr("onclick","accordeon(this);"),t},dragndrop:function(t,e,i){var n=t.find("li:first-child").text().split("|"),s=n[1].split("x"),r=!1,a="";if(i&&i.test&&(a+=(t.prev().attr("start")||1)+". "+t.prev().text().replace(/\n/g,"")+" | "+t.find("li:first-child").text()+"\n",t.find("li:not(:first)").each(function(){a+="+ "+$(this).text()+"\n"})),t.find("li:first-child").remove(),t.addClass("dnd-workspace").wrap('<div class="dnd" />'),t.find("li").each(function(){$(this).text().indexOf("!!!")>-1&&($(this).parent("ul").attr("data-finalmsg",$(this).text().replace("!!!","").trim()),$(this).remove())}),t.css({width:parseInt(s[0]),height:parseInt(s[1])}),["table","таблица"].indexOf(n[0].trim())&&t.parents(".dnd").prev().is("table")){t.parents(".dnd").prepend(t.parents(".dnd").prev().addClass("scheme-dnd-table").css({width:parseInt(s[0]),height:parseInt(s[1])}));var o=t.parents(".dnd").find("table tr");r=parseInt(s[1])/o.length,o.css({height:r+"px"})}else t.css({backgroundImage:'url("'+n[0].trim()+'")'});t.after('<div class="dnd-list cf" style="width:'+parseInt(s[0])+'px">');var u=[];return t.find("li").each(function(t){var e=$(this).html(),i=["50%","50%"];"["==e[0]&&e.indexOf("]")>-1&&(i=e.split("]")[0].split(",").map(function(t){return parseInt(t.replace(/\[/,""))}),i.forEach(function(t,e){i[e]+="%"}),e=e.split("]"),e.shift(),e=e.join("]")),e=function(){var t=$("<div>");return t.append(e),t.find("*").each(function(){$(this).text().trim()||$(this).remove()}),t.html()}();var s=t,a=!1,o=0;u.forEach(function(e,n){e[0]==i[0]&&e[1]==i[1]&&(s==t&&(s=n),a=!0,o++)}),u.push(i),$(this).parent("ul").next(".dnd-list").append('\n<div unselectable="on" data-for="'+s+'" class="dnd-dragbox" data-hint="'+o+'" style="height:'+(r?r-10+"px":"")+'">\n                        <span unselectable="on">\n                            '+e.replace(/^(.*)\|(.*)+/,"$1").trim()+"\n                        </span>\n                    </div>\n"),a?($(this).parent().find(".dnd-dropbox").eq(s).append('\n<div class="scheme-map-hint block-hint" data-hint="'+o+'">\n'+e.replace(/^(.*)\|/gm,"").trim()+"\n</div>\n"),$(this).remove()):$(this).replaceWith($("<div>").addClass("dnd-dropbox").css({left:i[0],top:i[1],background:n[2]?n[2].trim().match(/\u0431\u0435\u0437 \u043D\u0443\u043C\u0435\u0440\u0430\u0446\u0438\u0438/i)>-1?"#fff":"transparent":"",height:r?r+"px":"",lineHeight:r?r+"px":""}).attr("data-feedback",e.trim().replace(/^(.*)\|/gm,"").replace(/(<([^>]+)>)/gi,"")).attr("data-size",10).html(n[2]&&n[2].trim().match(/\u0431\u0435\u0437 \u043D\u0443\u043C\u0435\u0440\u0430\u0446\u0438\u0438/i)>-1?"\n"+(t+1)+"\n":"").append('\n<div class="scheme-map-hint block-hint" data-hint="'+o+'">\n'+e.replace(/^(.*)\|/gm,"").trim()+"\n</div>\n"))}),t.replaceWith(function(){var t=$('<div class="dnd-workspace">');return $.each(this.attributes,function(e,i){t.attr(i.name,i.value)}),t.html($(this).html()),t}),i&&i.test?{output:t,tests:a||""}:t},dialog:function(t,e){var i=t.find("li:first-child").text().split("|"),n=i[1].split("x");return t.find("li:first-child").remove(),t.css({backgroundImage:'url("'+i[0].trim()+'")',width:parseInt(n[0]),height:parseInt(n[1])}),t.find("li").each(function(t){var i=$(this).html(),n=[50,50];"["==i[0]&&i.indexOf("]")>-1&&(n=i.split("]")[0].split(",").map(function(t){return parseInt(t.replace(/\[/,""))}),n.forEach(function(t,e){n[e]+="%"}),i=i.split("]"),i.shift(),i=i.join("]")),$(this).css({left:n[0],top:n[1],zIndex:999-t}).html('\n<div class="'+e+'-replica">'+i.replace(/\&nbsp\;/,"").trim()+"</div>\n"),parseInt(n[0])>50&&$(this).find("."+e+"-replica").addClass("right"),!t&&$(this).find("."+e+"-replica").addClass("showed")}),t.find("li").length>1&&(t.append('<div class="dialog-arrs"><a href="#" class="dialog-arr darr-left"></a><a href="#" class="dialog-arr darr-right"></a></div>'),t.find(".dialog-arrs .darr-right").addClass("showed")),t},obj:function(t,e){var i=t.find("li:first-child").text().split("|"),n=i[1].split("x"),s=i[2]&&!i[2].match(/\u043A\u0440\u0443\u0433/i)&&i[2].trim(),r=s?i[3]&&i[3].match(/\u043A\u0440\u0443\u0433/i):i[2]&&i[2].match(/\u043A\u0440\u0443\u0433/i);return t.find("li:first-child").remove(),t.css({backgroundImage:'url("'+i[0].trim()+'")',width:parseInt(n[0]),height:parseInt(n[1])}),t.find("li").each(function(){var t,i=$(this).html(),n=[50,50];"["==i[0]&&i.indexOf("]")>-1&&(n=i.split("]")[0].split(",").map(function(t){return parseInt(t.replace(/\[/,""))}),n=n.map(function(t){return t+="%"}),t=i.split("]")[2]&&i.split("]")[1].replace(/\[/g,"").split("x"),i=i.split("]"),i.shift(),t&&i.shift(),i=i.join("]"),s&&!t&&(t=s.split("x"))),$(this).css({left:n[0],top:n[1]}).html('\n<div class="'+e+"-point"+(r?" rounded":"")+'" '+(t?'style="width:'+t[0]+"px;"+(t[1]?"height:"+t[1]:"height:"+t[0])+'px"':"")+'> </div>\n<div class="'+e+'-hint block-hint">\n'+i.replace(/\&nbsp\;/," ").trim()+"\n</div>\n")}),t}},schemesFormat={types:Object.keys(schemesHandler),run:function(t){var e,i,n,s,r="";return t=this.formatInfo(t),t=this.removeComm(t),e=this.textToDOM(t),e.find("p, li").each(function(){var t=$(this).text().trim();" "!=t&&" "!=t&&"&nbsp;"!=t&&t&&"undefined"!=t||$(this).remove()}),s=this.schemeCheck(e),e=s.output,r+=s.tests,n=this.checkTests(e),n.tests&&(e=n.output,r+=n.tests),e.find("table:not(.scheme-dnd-table)").wrap('<div class="tablestyle" />'),e.find("table th p, td p").each(function(){$(this).replaceWith(this.childNodes)}),e.find("a").attr("target","_blank"),i=this.postFormat(e.html()),{html:i,questions:r||"",schemes:this.scList}},removeComm:function(t){var e,i=t;return e=i.match(/\{[\s\S]*?\}/gm),e&&e.length&&function(){var t=e.map(function(t,e){return(t.match(/<[^>]*>/gm)||[]).join("")});e.forEach(function(e,n){i=i.replace(e,t[n])})}(),i},formatInfo:function(t){return t.replace(/#\{[\s]?([\s\S]*?)\}/gm,'<div class="block-comment">$1</div>')},schemeCheck:function(t){var e,i,n=this.textToDOM(t),s=this.types,r="";return this.scList=[],n.find("ul").each(function(){var t=$(this).find("li:first-child").text().toLowerCase();(s.indexOf(t.replace(/scheme-/gi,""))>-1||s.indexOf(t.replace(/test-/gi,""))>-1)&&($(this).find("li").each(function(){$(this).text().indexOf("???")>-1&&($(this).parent("ul").after('\n\r<div class="legend">\n\r'+$(this).text().trim().replace(/\?\?\?/,"")+"\n\r</div>\n\r"),$(this).remove())}),i=schemesFormat.schemeRepalce($(this)),e=i.output,r+=i.tests,$(this).replaceWith(e))}),{output:n,tests:r||""}},schemeRepalce:function(t){var e=t.find("li:first-child").text().toLowerCase(),i="",n=function(t){return e.indexOf(t)>-1};if(this.scList.push(e.replace("scheme-","")),t.addClass(e),t.find("li:first-child").remove(),n("logo"))t=schemesHandler.logo(t,e);else if(n("map"))t=schemesHandler.map(t,e);else if(n("accordeon"))t=schemesHandler.accordeon(t,e);else if(n("dragndrop")){if(n("scheme"))t=schemesHandler.dragndrop(t,e);else if(n("test")){var s=schemesHandler.dragndrop(t,e,{test:!0});t=s.output,i+=s.tests}}else n("dialog")?t=schemesHandler.dialog(t,e):n("obj")&&(t=schemesHandler.obj(t,e));return{output:t,tests:i||""}},checkTests:function(t){t.find("ol").each(function(){var t;if($(this).next().is("p")&&(t=$(this).next().text())&&t.match(/\u043F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u044B((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*) \u043E\u0442\u0432\u0435\u0442/i)&&$(this).prev().is("ol")&&1==$(this).prev().find("li").length){$(this).addClass("test-question");var e;t.match(/\u043D\u044B\u0439/gim)?(e=t.replace(/(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*\u043D\u044B\u0439 (?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*\u0432\u0435\u0442/gim,"").replace(/:/gim,"").trim(),$(this).find("li").each(function(){$(this).text()[0].trim()==e?$(this).text("* "+$(this).text().replace(/^[\S]\. /gim,"")):$(this).text(" "+$(this).text().replace(/^[\S]\. /gim,""))})):t.match(/(\u043D\u044B\u0435|\u0432\u0435\u0442\u044B)/gim)&&(e=t.trim().replace(/(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*\u043D\u044B\u0435 (?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*\u0432\u0435\u0442\u044B/gim,"").replace(/:/gim,"").split(","),e=e.map($.trim),$(this).find("li").each(function(){var t=e.indexOf($(this).text()[0].trim())>-1?"+":"-";$(this).text(t+" "+$(this).text().replace(/^[\S]\. /gim,""))}));var i=$(this).prev();$(this).attr("data-quest",(i.attr("start")||1)+". "+i.find("li").text()),$(this).prev().remove(),$(this).next().remove()}else 1==$(this).find("li").length&&$(this).next().is("ul")&&($(this).next().find("li").text().indexOf("~")>-1||$(this).next().find("li").text().indexOf("->")>-1||$(this).next().find("li").text().indexOf("-&gt;")>-1)?($(this).next().addClass("test-question").attr("data-quest",($(this).attr("start")||1)+". "+$(this).find("li").text()),$(this).remove()):1==$(this).find("li").length&&$(this).text().indexOf("%%")!=-1&&$(this).next().is("p")&&$(this).next().text().indexOf("%%")!=-1&&($(this).addClass("test-question").attr("data-quest",($(this).attr("start")||1)+". "+$(this).find("li").text()).find("li").html($(this).next().html()),$(this).next().remove())});var e="";return t.find(".test-question").each(function(t){e+=(t?"\n":"")+$(this).data("quest"),$(this).find("li").each(function(){e+="\n"+$(this).text()}),e+="\n",$(this).remove()}),{output:t,tests:e}},postFormat:function(t){return t.replace(/^(?:[\t ]*(?:\r?\n|\r))+/gm,"").replace(/&quot;/gm,"'").replace(/\\n/gm,"<br>").replace(/^<p>(.*.(?:png|jpg|jpeg|gif|svg))?\s*<\/p>+/gm,'<img src="$1" alt="" class="inserted-img">').replace(/\<([^\/]*)\>[\s|\n]+\<\//g,"<$1></").replace(/<\/(.*)><([^\/](.*))>/g,"</$1>\n<$2>")},textToDOM:function(t){return t instanceof $?t:$("<div />").append(t.replace(/&nbsp;/gm," "))}};!function(){function t(t,e){var r=e.getContent(),a=formatScheme(r),o=a.html||"",u=a.schemes.map(function(t){return t.replace(/scheme-|test-/g,"")});localStorage.setItem("formInput",r),a.questions?($(".text-questions").hide(),s(n(a.questions),function(t){var e=t.split(";");e[0]=e[0]+";charset=utf-8",$(".text-questions").show().html('<a href="'+e.join(";")+'" target="_blank">Открыть файл</a>')})):$(".text-questions").hide(),t.getDoc().setValue(o);for(var d=0;d<t.lineCount();d++)t.indentLine(d);u.indexOf("obj")>-1?($(".border-show").addClass("showed"),$('.border-show input[type="checkbox"]').is(":checked")&&(o=o.replace(/scheme-obj-point/g,"scheme-obj-point outline"))):$(".border-show").removeClass("showed"),$(".output").html(o),$("#viewbox").contents().find("main").html(o);var c=["map","dragndrop","dialog","obj"];c.map(function(t){return u.map(function(e){return t==e}).indexOf(!0)>-1}).indexOf(!0)>-1?($(".coord-hint").addClass("showed"),i(c)):$(".coord-hint").removeClass("showed"),$("#viewbox").ready(function(){if(u.indexOf("dragndrop")>-1)for(var t=0;t<3;t++)$("#viewbox")[0].contentWindow.dndInit();u.indexOf("dialog")>-1&&$("#viewbox")[0].contentWindow.dialogInit()})}function e(){setTimeout(function(){var t=$(".mce-tinymce").css("border","none").parent().outerHeight();t+=-$(".mce-menubar.mce-toolbar").outerHeight()-$(".mce-toolbar-grp").outerHeight()-1,$(".mce-edit-area").height(t)},200)}function i(t){var e=$(".coord-hint");$("#viewbox").contents().find(t.map(function(t){return".scheme-"+t}).join(", ")).on("mousemove mouseover",function(t){if(t.altKey){var i={x:(t.pageX-$(this).offset().left)/$(this).outerWidth(),y:(t.pageY-$(this).offset().top)/$(this).outerHeight()};for(var n in i)i[n]=~~Math.max(100*i[n])/1;e.val(i.x+", "+i.y)}else e.removeAttr("style")})}function n(t){var e=new Blob([t],{encoding:"UTF-8",type:"text/plain"});return e}function s(t,e){var i=new FileReader;i.onload=function(t){e(t.target.result)},i.readAsDataURL(t)}$(function(){var i,n=CodeMirror.fromTextArea($(".output")[0],{mode:"text/html",indentWithTab:!0,tabSize:4,lineNumbers:!0,readOnly:!0});tinymce.init({selector:".workspace div",plugins:"paste",setup:function(e){e.on("change input undo redo keydown keypress keyup",function(s){clearTimeout(i),i=setTimeout(function(){t(n,e)},150)}),e.on("init",function(i){var s=localStorage.getItem("formInput");s&&i.target.setContent(s),$("#viewbox").load(function(){t(n,e)})})}}),$(window).resize(function(){e()}).resize(),$(window).resize();for(var s=0;s<3;s++)setTimeout(function(){return $(window).resize()},100*s);$(".coord-hint, .image-url").focus(function(){$(this).select()}),imgDropInit(),$('.border-show input[type="checkbox"]').change(function(){$(this).is(":checked")?$("#viewbox").contents().find(".scheme-obj-point").addClass("outline"):$("#viewbox").contents().find(".scheme-obj-point").removeClass("outline")})}),e()}();