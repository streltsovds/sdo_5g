(function ($) {
    $.fn.collapsorz = function (options) {
        var defaults = {
            toggle: "> *",
            minimum: 5,
            linkLocation: "after",
            defaultState: "collapsed",
            wrapLink: null,
            callback: null
        };
        var options = $.extend(defaults, options);
        return this.each(function () {
            var $targets = $(options.toggle, this);
            if ($targets.length > options.minimum) {
                var $obj = $(this);
                if (options.defaultState == "collapsed") {
                    $targets.filter(":gt(" + (options.minimum - 1) + ")").hide();
                }
                var $toggler = $('<div class="div_expand"></div>');
                if (options.linkLocation == "before") {
                    $obj.before($toggler)
                } else {
                    $obj.prepend($toggler)
                }
                if (options.wrapLink) {
                    $toggler.wrap(options.wrapLink)
                }
                if (options.defaultState == "expanded") {
                    $obj.data("status", "expanded");
                    $toggler.addClass("expanded");
                } else {
                    $obj.data("status", "collapsed");
                    $toggler.addClass("collapsed");
                }
                $obj.find("> *").wrapAll("<div class=\"td_div_expand\"></div>");
                $toggler.click(function () {
                    if ($obj.data("status") == "collapsed") {
                        $targets.filter(":hidden").show();
                        $obj.data("status", "expanded")
                        $(this).parents("td").addClass('expand_shown')
                    } else if ($obj.data("status") == "expanded") {
                        $targets.filter(":gt(" + (options.minimum - 1) + ")").hide();
                        $obj.data("status", "collapsed")
                        $(this).parents("td").removeClass('expand_shown')
                    }
                    $(this).toggleClass("collapsed").toggleClass("expanded");                    
                    if(typeof options.callback=="function") options.callback(this);						  					             
                    return false
                })
            }
        })
    }
})(jQuery);