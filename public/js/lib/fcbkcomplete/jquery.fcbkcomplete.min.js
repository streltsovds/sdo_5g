(function(e){e.fn.fcbkcomplete=function(L){return this.queue(function(){function m(a,b,c,g,j){if(!s())return!1;var g="bit-box"+(g?" locked":""),h;h="";for(var l=0;32>l;l++){var m=Math.floor(61*Math.random());h+="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz".substring(m,m+1)}m=document.createTextNode(p(a));l=e('<a class="closebutton" href="#"></a>');g=e('<li class="'+g+'" rel="'+b+'" id="pt_'+h+'"></li>').prepend(m).append(l);k.append(g);l.click(function(){y(e(this).parent("li"));
return!1});c||(e("#"+t+"_annoninput").remove(),H(j),a=e('<option value="'+p(b,1)+'" id="opt_'+h+'" class="selected" selected="selected">'+p(a)+"</option>"),f.append(a),d.onselect&&z(d.onselect,a),f.change());k.children("li.bit-box.deleted").removeClass("deleted");u(1);return h}function y(a){if(!a.hasClass("locked")){a.fadeOut("fast");var b=a.attr("id");if(d.onremove){var c=b?e("#o"+b+""):f.children("option[value="+a.attr("rel")+"]");z(d.onremove,c)}b?e("#o"+b+"").remove():f.children('option[value="'+
a.attr("rel")+'"]').remove();a.remove();f.change();A=0}}function H(a){var b=e('<li class="bit-input" id="'+t+'_annoninput">'),c=e('<input type="text" class="maininput" size="'+d.input_min_size+'" autocomplete="off">');0<d.input_tabindex&&c.attr("tabindex",d.input_tabindex);""!=d.input_name&&c.attr("name",d.input_name);k.append(b.append(c));c.focus(function(){B=!0;s()&&l.fadeIn("fast")});c.blur(function(){B=!1;C&&l.fadeOut("fast")});k.click(function(){0>d.input_min_size&&g.length&&I(n(c.val(),1));
c.focus();g.length&&c.val().length>d.input_min_size?g.show():(u(1),l.children(".default").show().end().position({my:"left top",at:"left bottom",of:k}))});c.keypress(function(a){l.position({my:"left top",at:"left bottom",of:k});if(a.keyCode==h.enter)return!1;a=d.input_min_size>c.val().length?d.input_min_size:c.val().length+1;c.attr("size",a).width(parseInt(c.css("font-size"))*a)});c.keyup(function(a){var b=n(c.val(),1);if(a.keyCode==h.backspace&&0==b.length&&(u(1),!k.children("li.bit-box:last").hasClass("locked"))){if(0==
k.children("li.bit-box.deleted").length)return k.children("li.bit-box:last").addClass("deleted"),!1;if(A)return;A=1;k.children("li.bit-box.deleted").fadeOut("fast",function(){y(e(this));return!1})}a.keyCode!=h.downarrow&&(a.keyCode!=h.uparrow&&a.keyCode!=h.leftarrow&&a.keyCode!=h.rightarrow&&b.length>d.input_min_size)&&(I(b),l.children(".default").hide(),g.show())});d.oncreate&&z(d.oncreate,c);a&&setTimeout(function(){c.focus();l.children(".default").show().end().position({my:"left top",at:"left bottom",
of:k})},1)}function D(a,b){g.html("");!d.cache&&null!=b&&q.clear();if(d.newel&&s()&&(g.children("li[fckb=1]").remove(),0!=a.length)){var c=e('<li rel="'+a+'" fckb="1">').html(p(a));g.prepend(c);v++}null!=b&&b.length&&e.each(b,function(a,b){q.set(n(b.key),n(b.value))});var h=d.maxshownitems<q.length()?d.maxshownitems:q.length(),m="";e.each(q.search(a),function(b,c){if(h&&(!d.filter_selected||!f.children('option[value="'+c.key+'"]').hasClass("selected"))){var e=m,g='<li rel="'+c.key+'">',j=c.value,
k=d.filter_begin?"<em>$1</em>$2":"$1<em>$2</em>$3",l=(d.filter_begin?"":"(.*)")+(d.filter_case?"("+a+")(.*)":"("+a.toLowerCase()+")(.*)");try{j=j.replace(RegExp(l,d.filter_case?"g":"gi"),k)}catch(n){}m=e+(g+p(j)+"</li>");v++;h--}});g.append(m);d.firstselected&&(j=g.children("li:visible:first"),j.addClass("auto-focus"));v>d.height?g.css({height:24*d.height+"px",overflow:"auto"}):g.css("height","auto");s()&&l.is(":hidden")&&l.show().position({my:"left top",at:"left bottom",of:k})}function J(){g.children("li").mouseover(function(){g.children("li").removeClass("auto-focus");
j=e(this);j.addClass("auto-focus")});g.children("li").mouseout(function(){e(this).removeClass("auto-focus");j=null})}function E(){var a=e("#"+t+"_annoninput").children(".maininput");J();g.children("li").unbind("mousedown").mousedown(function(){var a=e(this);m(a.text(),a.attr("rel"),0,0,1);u(1);l.hide()});a.unbind("keydown");a.keydown(function(b){b.keyCode!=h.backspace&&k.children("li.bit-box.deleted").removeClass("deleted");if((b.keyCode==h.enter||b.keyCode==h.tab)&&w()){var c=j;m(c.text(),c.attr("rel"),
0,0,1);return r(b)}if((b.keyCode==h.enter||b.keyCode==h.tab)&&!w()){if(d.newel)return c=n(e(this).val()),m(c,c,0,0,1),r(b);if(d.addontab&&d.newel)return c=j=g.children("li:visible:first"),m(c.text(),c.attr("rel"),0,0,1),r(b)}b.keyCode==h.downarrow&&K("first");b.keyCode==h.uparrow&&K("last");b=d.input_min_size>a.val().length?d.input_min_size:a.val().length+1;a.attr("size",b).width(parseInt(a.css("font-size"))*b)});a.unbind("keypress");a.keypress(function(b){if(b.charCode==h.comma&&w()){var c=j;m(c.text(),
c.attr("rel"),0,0,1);return r(b)}if(b.charCode==h.comma&&!w()){if(d.newel)return c=n(e(this).val()),m(c,c,0,0,1),r(b);if(d.addoncomma&&d.newel)return c=j=g.children("li:visible:first"),m(c.text(),c.attr("rel"),0,0,1),r(b)}b=d.input_min_size>a.val().length?d.input_min_size:a.val().length+1;a.attr("size",b).width(parseInt(a.css("font-size"))*b)})}function K(a){g.unbind("mouseover").unbind("mouseout").mousemove(function(){J();g.unbind("mousemove")});if(null==j||0==j.length)j=g.children("li:visible:"+
a),g.get(0).scrollTop="first"==a?0:parseInt(j.get(0).scrollHeight,10)*(parseInt(g.children("li:visible").length,10)-Math.round(d.height/2));else{j.removeClass("auto-focus");j="first"==a?j.nextAll("li:visible:first"):j.prevAll("li:visible:first");var b=parseInt(j.prevAll("li:visible").length,10),c=parseInt(j.nextAll("li:visible").length,10);if((("first"==a?b:c)>Math.round(d.height/2)||("first"==a?b:c)<=Math.round(d.height/2))&&"undefined"!=typeof j.get(0))g.get(0).scrollTop=parseInt(j.get(0).scrollHeight,
10)*(b-Math.round(d.height/2))}g.children("li").removeClass("auto-focus");j.addClass("auto-focus")}function r(a){l.hide();a.preventDefault();j=null;return!1}function s(){return 0!=d.maxitems&&k.children("li.bit-box").length<d.maxitems}function z(a,b){var c={};for(i=0;i<b.get(0).attributes.length;i++)null!=b.get(0).attributes[i].nodeValue&&(c["_"+b.get(0).attributes[i].nodeName]=b.get(0).attributes[i].nodeValue);return a.call(a,c)}function w(){return null==j||0==j.length?!1:!0}function n(a,b){a=""+
a;if("undefined"!=typeof b){for(i=0;i<a.length;i++){var c=a.charCodeAt(i);if(h.exclamation<=c&&c<=h.slash||h.colon<=c&&c<=h.at||h.squarebricket_left<=c&&c<=h.apostrof)a=a.replace(a[i],escape(a[i]))}a=a.replace(/(\{|\}|\*)/i,"\\$1")}return a.replace(/script(.*)/g,"")}function p(a,b){a=a.toString();a=a.replace("\\","");return"undefined"!=typeof b?a:unescape(a)}function u(a){g.children().remove();a&&g.hide()}function I(a){v=0;if(d.json_url&&s())if(d.cache&&F.get(a))D(a),E();else{G++;var b=G;setTimeout(function(){b==
G&&e.getJSON(d.json_url,{tag:p(a)},function(b){B&&(e.each(b,function(){var a=this.value;this.value=""+this.key;this.key=""+a}),D(a,b),F.set(a,1),E())})},d.delay)}else D(a),E()}var d=e.extend({json_url:null,width:512,cache:!1,height:"10",newel:!1,addontab:!1,addoncomma:!1,firstselected:!1,filter_case:!1,filter_selected:!1,filter_begin:!1,complete_text:"Start to type...",select_all_text:null,maxshownitems:30,maxitems:10,oncreate:null,onselect:null,onremove:null,attachto:null,delay:350,input_tabindex:0,
input_min_size:1,input_name:"",bricket:!0},L),k=null,g=null,l=null,v=0,B=!1,j=null,A=0,C=1,f=e(this),t=f.attr("id"),G=0,F={set:function(a,b){var c=f.data("jsoncache");c[a]=b;f.data("jsoncache",c)},get:function(a){return"undefined"!=f.data("jsoncache")[a]?f.data("jsoncache")[a]:null},init:function(){f.data("jsoncache",{})}},h={enter:13,tab:9,comma:44,backspace:8,leftarrow:37,uparrow:38,rightarrow:39,downarrow:40,exclamation:33,slash:47,colon:58,at:64,squarebricket_left:91,apostrof:96},q={search:function(a){var b=
[],c=RegExp((d.filter_begin?"^":"")+a,d.filter_case?"g":"gi");e.each(f.data("cache"),function(a,d){"function"===typeof d.search&&-1!=d.search(c)&&b.push({key:a,value:d})});return b},set:function(a,b){var c=f.data("cache");c[a]=b;f.data("cache",c)},get:function(a){return"undefined"!=f.data("cache")[a]?f.data("cache")[a]:null},clear:function(){f.data("cache",{})},length:function(){if("object"==typeof f.data("cache")){var a=0;for(i in f.data("cache"))a++;return a}return f.data("cache").length},init:function(){"undefined"==
f.data("cache")&&f.data("cache",{})}},k=e('<ul class="holder"></ul>').width(d.width);d.attachto?"object"==typeof d.attachto?d.attachto.append(k):e(d.attachto).append(k):f.after(k);l=e('<div class="facebook-auto">').width(k.outerWidth());""!=d.complete_text&&(l.append('<div class="default">'+d.complete_text+"</div>"),d.select_all_text&&l.children(".default").append(e('<a href="" class="select_all_items">'+d.select_all_text+"</a>").click(function(){e(f).trigger("selectAll");return!1})));l.hover(function(){C=
0},function(){C=1});g=e('<ul id="'+t+'_feed"></ul>').width(d.width);l.prepend(g).appendTo("body").position({my:"left top",at:"left bottom",of:k});name=f.attr("name");d.bricket&&"undefined"!=typeof name&&-1==name.indexOf("[]")&&(name+="[]");var x=e("<"+f.get(0).tagName+' name="'+name+'" id="'+t+'" multiple="multiple" class="'+f.get(0).className+' hidden">').data("cache",{});e.each(f.children("option"),function(a,b){b=e(b);x.data("cache")[b.val()]=b.text();if(b.hasClass("selected")){var c=m(b.text(),
b.val(),!0,b.hasClass("locked"));x.append('<option value="'+b.val()+'" selected="selected" id="opt_'+c+'"class="selected">'+b.text()+"</option>")}});f.after(x);f.remove();f=x;e(f).bind("addItem",function(a,b){m(b.title,b.value,0,0,0)});e(f).bind("removeItem",function(a,b){var c=k.children("li[rel="+b.value+"]");c.length&&y(c)});e(f).bind("destroy",function(){k.remove();l.remove();f.show()});e(f).bind("selectAll",function(){var a=e(f).val()||[];e.each(e(f).data("cache"),function(b,c){-1===e.inArray(b,
a)&&m(c,b,0,0,0)});g.parent().hide()});H(0);F.init();q.init();return this})}})(jQuery);
