(function(a,b,c){function o(a){var b="init save data".split(" ");return _.all(b,function(b){return _.isFunction(a[b])})}function p(a){var b="then done fail isResolved isRejected promise".split(" "),c=!!a&&typeof a=="object";while(c&&b.length)if(!a[b.shift()])return!1;return c}function q(a){var c=_.isFunction(a)?a():a,d=c;return p(d)||(d=b.Deferred(),c?d.resolve():d.reject()),d.promise()}function r(a,c,d){var f;if(i)return;if(!a||!_.isString(a)||!_.isUndefined(e[a])||!o(c))return;f=e[a]={fn:c,priority:d||0,name:a,data:null,isAvailable:null,deferred:b.Deferred()},q(c.isAvailable).always(function(){f.isAvailable=this.isResolved()}).done(function(){if(j)return;q(f.fn.init).done(function(){f.data=f.fn.data()}).then(function(){f.deferred.resolve()},function(){f.deferred.reject()})})}function s(a){var c,d=b.Deferred();return _.delay(function(){d.resolve()},_.isNumber(a)&&a>11?a:f),c=_.reject(e,function(a){return a.deferred.isResolved()||a.deferred.isRejected()}),b.when.apply(b,_.pluck(c,"deferred")).always(function(){d.resolve()}),d.promise()}function t(a){var c=b.Deferred();return _.delay(function(){c.resolve()},_.isNumber(a)&&a>11?a:f),_.each(e,function(a){a.refreshDeferred=q(a.fn.refresh),a.refreshDeferred.done(function(){a.data=a.fn.data()})}),b.when.apply(b,_.pluck(e,"refreshDeferred")).always(function(){c.resolve()}),c.promise()}function u(b){return k?n:(k=!0,i=!0,s(b).always(function(){j=!0,e=_.select(e,function(a){return a.isAvailable}).sort(function(a,b){return(a.priority||0)-(b.priority||0)}),g=_.reduce(e,function(a,b){return _.extend(a,b.data||{})},{}),d=_.pluck(e,"fn"),_.extend(a.PStore,{get:w,set:v,clear:y,refresh:A}),m.resolveWith(a.PStore,[])}),a.PStore)}function v(a,b,c){if(!C(a))return;_.isUndefined(b)?delete g[a]:g[a]=JSON.stringify(b),c?x():h()}function w(a,b){if(!C(a)||!g[a])return;return JSON.parse(g[a])}function x(){_.each(d,function(a){var b=a.data()||{},c=B(b,g);c.length&&a.save(_.extend({},g),c)})}function y(a){g={},a?x():h()}function A(c){var d;return z&&!z.isResolved()&&!z.isRejected()?z:(d=b.Deferred(),z=d.promise(),t(c).always(function(){g=_.reduce(e,function(a,b){return _.extend(a,b.data||{})},{}),d.resolveWith(a.PStore,[])}),z)}function B(a,b){var c=[],d=[],e=[];return _.each(a,function(a,d){_.isString(a)&&!_.isString(b[d])&&c.push(d),_.isString(a)&&_.isString(b[d])&&a!==b[d]&&e.push(d)}),_.each(b,function(b,c){_.isString(b)&&!_.isString(a[c])&&d.push(c)}),{added:d,removed:c,changed:e,length:d.length+c.length+e.length}}function C(a){return _.isString(a)&&/^[a-z0-9\-_]+$/i.test(a||"")}var d={},e={},f=1e4,g={},h=_.debounce(x,10),i,j,k,l={},m=b.Deferred(),n=m.promise(l);if(a.PStore)return;b(a).bind("unload",x);var z;Modernizr.localstorage&&r("localstorage",function(){var b,c,d;return d={init:function(){return c=a.localStorage,d.refresh()},refresh:function(){b={};for(var a=0,d=c.length;a<d;++a)b[c.key(a)]=c.getItem(c.key(a));return!0},save:function(a,d){_.each(d.removed,function(a){c.removeItem(a)}),_.each(d.added.concat(d.changed),function(b){c.setItem(b,a[b])}),b=a},data:function(){return b},isAvailable:Modernizr.localstorage}}()),!Modernizr.localstorage&&r("userData",function(){function e(){var c=b.XMLDocument.documentElement.attributes,d;a={};for(var e=0,f=c.length;e<f;++e)d=c.item(e),a[d.nodeName]=d.nodeValue}function f(){b&&b.parentNode.removeChild(b),!!document.documentElement&&!!document.documentElement.addBehavior&&(b=document.createElement(c),document.documentElement.insertBefore(b,document.documentElement.firstChild),b.addBehavior("#default#userData"),b.load(c))}var a,b,c="userdatadriver",d;return d={init:function(){return e(),!0},refresh:function(){return f(),e(),!0},data:function(){return a},save:function(d,e){_.each(e.removed,function(a){b.removeAttribute(a)}),_.each(e.added.concat(e.changed),function(a){b.setAttribute(a,d[a])}),b.save(c),a=d},isAvailable:function(){try{f()}catch(a){b=null}return!!b}}}()),a.PStore=_.extend(l,{init:u,register:r})})(window,jQuery);